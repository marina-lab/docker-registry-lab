# Consul Service Registration
# Used as a multi-host service registry.
# HTTP API is available over 8500.
#
# We bind port 53 of the container to port 53 of the docker0 bridge adapter,
# enabling Consul to serve as the DNS for containers.
#
# All other ports are bound to the "advertise_ip". If this is a publicly
# exposed IP, you need to whitelist your other hosts with firewall rules
# and encrypt your traffic!
#
# Requires the docker daemon to be run with:
# --dns {{ docker_bip }} --dns 8.8.8.8 --dns-search service.consul
#
# Port bindings:
# DNS server: {{ docker_bip }}:53:53
# HTTP API: 8500:8500
# RPC endpoint: 8400:8400
# Serf LAN port: 8301:8301
# Serf WAN port: 8302:8302
# Server RPC address: 8300:8300
 - name: create data directory for consul
   file: path={{ item }}
         state=directory
   with_items:
     - /var/docker_volumes/consul/consul.d
     - /var/docker_volumes/consul/data

 - name: run Consul container
   docker: >
     image="progrium/consul"
     command="-server -advertise {{ advertise_ip }} -bootstrap -data-dir /data -config-dir /etc/consul.d"
     env="SERVICE_8500_NAME=consul"
     ports="{{ advertise_ip }}:8300:8300,{{ advertise_ip }}:8301:8301,{{advertise_ip}}:8301:8301/udp,{{ advertise_ip }}:8302:8302,{{ advertise_ip }}:8302:8302/udp,{{ advertise_ip }}:8400:8400,{{ advertise_ip }}:8500:8500,{{ docker_bip }}:53:53/udp"
     name="consul"
     hostname="{{ ansible_hostname }}"
     volumes="/var/docker_volumes/consul/consul.d:/etc/consul.d,/var/docker_volumes/consul/data:/data"
     state=running

 - name: use consul as local dns resolver
   lineinfile: >
     dest=/etc/sysconfig/network-scripts/ifcfg-eth0
     regexp=^DNS1=
     line=DNS1={{ docker_bip }}
